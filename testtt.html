<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบ POS ร้านขายข้าวสาร</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Kanit', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: white;
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .mode-toggle {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .mode-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .mode-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .mode-btn.active {
            background: #43a047;
            box-shadow: 0 4px 15px rgba(67, 160, 71, 0.4);
        }

        .status {
            color: #e8f5e8;
            font-size: 1.1em;
            margin-left: auto;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: none;
            padding: 15px 25px;
            border-radius: 15px;
            color: white;
            font-size: 1.1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .search-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: 500;
            color: #333;
            font-size: 0.9em;
        }

        .filter-input {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .filter-input:focus {
            outline: none;
            border-color: #43a047;
            box-shadow: 0 0 0 3px rgba(67, 160, 71, 0.1);
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .product-card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #43a047, #66bb6a);
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            border-color: #43a047;
        }

        .product-image {
            width: 100%;
            height: 180px;
            background: #f5f5f5;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 15px;
        }

        .product-image.placeholder {
            background: linear-gradient(45deg, #f5f5f5, #e0e0e0);
            color: #999;
            font-size: 3em;
        }

        .product-info h3 {
            color: #333;
            font-size: 1.2em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .product-brand {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .product-price {
            color: #43a047;
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .product-stock {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .stock-badge {
            background: #e8f5e8;
            color: #43a047;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .product-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-primary {
            background: #43a047;
            color: white;
        }

        .btn-primary:hover {
            background: #388e3c;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background: #f57c00;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .cart-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .cart-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .cart-header h2 {
            color: #333;
            font-size: 1.8em;
            font-weight: 600;
        }

        .cart-items {
            margin-bottom: 20px;
        }

        .cart-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-bottom: 10px;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .cart-item-price {
            color: #43a047;
            font-weight: 500;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            width: 35px;
            height: 35px;
            border: none;
            border-radius: 50%;
            background: #43a047;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quantity-btn:hover {
            background: #388e3c;
            transform: scale(1.1);
        }

        .quantity {
            font-weight: 600;
            font-size: 1.1em;
            min-width: 30px;
            text-align: center;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            transition: border-color 0.2s, box-shadow 0.2s;
            outline: none;
            padding: 4px 8px;
        }

        .quantity:focus {
            border-color: #43a047;
            box-shadow: 0 0 0 2px rgba(67,160,71,0.15);
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #43a047, #66bb6a);
            color: white;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .cart-total h3 {
            font-size: 1.5em;
            font-weight: 600;
        }

        .checkout-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #43a047, #66bb6a);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.3em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(67, 160, 71, 0.3);
        }

        .checkout-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #43a047;
            box-shadow: 0 0 0 3px rgba(67, 160, 71, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .admin-only {
            display: none;
        }

        .admin-mode .admin-only {
            display: block;
        }

        /* แก้ไขปัญหา tab-content admin-only แสดงผลผิดพลาด */
        .tab-content.admin-only {
            display: none !important;
        }

        .admin-mode .tab-content.admin-only.active {
            display: block !important;
        }


        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #43a047;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .history-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #43a047;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-date {
            color: #666;
            font-size: 0.9em;
        }

        .history-total {
            color: #43a047;
            font-weight: 600;
            font-size: 1.2em;
        }

        .history-items {
            color: #666;
            font-size: 0.9em;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .report-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .report-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .report-value {
            font-size: 2em;
            font-weight: 700;
            color: #43a047;
            margin-bottom: 10px;
        }

        .report-label {
            color: #666;
            font-size: 0.9em;
        }

        .stock-update {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }

        /* Notification Bell */
        .notification-bell {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1500;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .notification-bell:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);
        }

        .bell-icon {
            font-size: 1.5em;
            color: #667eea;
        }

        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f44336;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: bold;
            border: 2px solid white;
        }

        .notification-count.hidden {
            display: none;
        }

        /* Notification History Modal */
        .notification-history-content {
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .notification-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .notification-history-header h2 {
            margin: 0;
            color: #333;
        }

        .notification-history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #ff9800;
            transition: all 0.3s ease;
        }

        .notification-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .notification-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .notification-item-title {
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-item-time {
            font-size: 0.8em;
            color: #666;
        }

        .notification-item-content {
            color: #666;
            font-size: 0.9em;
        }

        .notification-item-content ul {
            margin: 5px 0 0 0;
            padding-left: 20px;
        }

        .notification-item-content li {
            margin-bottom: 2px;
        }

        /* Low Stock Notification */
        .low-stock-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            max-width: 400px;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-content {
            padding: 15px;
        }

        .notification-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .notification-icon {
            font-size: 1.5em;
        }

        .notification-title {
            font-weight: 600;
            color: #856404;
            flex: 1;
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #856404;
            cursor: pointer;
            padding: 0;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .notification-close:hover {
            background-color: rgba(133, 100, 4, 0.1);
        }

        .notification-body {
            color: #856404;
        }

        .notification-body p {
            margin-bottom: 8px;
            font-weight: 500;
        }

        .notification-body ul {
            margin: 0;
            padding-left: 20px;
        }

        .notification-body li {
            margin-bottom: 3px;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .search-filters {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-input {
                min-width: 100%;
            }

            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }

            .low-stock-notification {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
    </style>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🌾 ระบบ POS ร้านขายข้าวสาร</h1>
            <div class="mode-toggle">
                <button class="mode-btn active" id="userMode">โหมดพนักงาน</button>
                <button class="mode-btn" id="adminMode">โหมดผู้ดูแล</button>
                <div class="status" id="statusText">โหมดพนักงาน</div>
            </div>
        </div>

        <!-- Notification Bell -->
        <div class="notification-bell" id="notificationBell">
            <span class="bell-icon">🔔</span>
            <span class="notification-count" id="notificationCount">0</span>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="sales">🛒 ขายสินค้า</button>
            <button class="tab" data-tab="stock">📦 จัดการ Stock</button>
            <button class="tab" data-tab="history">📋 ประวัติการขาย</button>
            <button class="tab admin-only" data-tab="products">⚙️ จัดการสินค้า</button>
            <button class="tab" data-tab="reports">📊 รายงานยอดขาย</button>
        </div>

        <!-- Sales Tab -->
        <div class="tab-content active" id="sales">
            <div class="search-filters">
                <div class="filter-group">
                    <label>ค้นหาสินค้า</label>
                    <input type="text" class="filter-input" id="searchProduct" placeholder="ชื่อสินค้าหรือยี่ห้อ...">
                </div>
                <div class="filter-group">
                    <label>ยี่ห้อ</label>
                    <select class="filter-input" id="brandFilter">
                        <option value="">ทั้งหมด</option>
                        <option value="CP">ข้าวซีพี</option>
                        <option value="Golden Phoenix">โกลเด้น ฟีนิกซ์</option>
                        <option value="Royal Umbrella">รอยัล อัมเบรลล่า</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>ราคาขั้นต่ำ</label>
                    <input type="number" class="filter-input" id="minPrice" placeholder="0" min="0">
                </div>
                <div class="filter-group">
                    <label>ราคาสูงสุด</label>
                    <input type="number" class="filter-input" id="maxPrice" placeholder="999999" min="0">
                </div>
            </div>

            <div class="products-grid" id="productsGrid">
                <!-- Products will be populated by JavaScript -->
            </div>

            <div class="cart-section">
                <div class="cart-header">
                    <h2>🛒 ตะกร้าสินค้า</h2>
                    <span class="stock-badge" id="cartCount">0 รายการ</span>
                </div>

                <div class="cart-items" id="cartItems">
                    <div class="empty-state">
                        <h3>ตะกร้าสินค้าว่างเปล่า</h3>
                        <p>เพิ่มสินค้าลงในตะกร้าเพื่อเริ่มการขาย</p>
                    </div>
                </div>

                <div class="cart-total">
                    <h3>ยอดรวม</h3>
                    <h3 id="totalAmount">0.00 บาท</h3>
                </div>

                <button class="checkout-btn" id="checkoutBtn" disabled>💳 ชำระเงิน</button>
            </div>
        </div>

        <!-- Stock Tab -->
        <div class="tab-content" id="stock">
            <h2>📦 จัดการ Stock</h2>
            <div class="products-grid" id="stockGrid">
                <!-- Stock items will be populated by JavaScript -->
            </div>
        </div>

        <!-- History Tab -->
        <div class="tab-content" id="history">
            <h2>📋 ประวัติการขาย</h2>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
                <label>จาก</label>
                <input type="date" id="historyStartDate">
                <label>ถึง</label>
                <input type="date" id="historyEndDate">
                <button class="btn btn-primary" id="printHistoryBtn">🖨️ พิมพ์ PDF</button>
            </div>
            <div id="historyListPrintArea">
                <div id="historyList">
                    <!-- History items will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Products Tab (Admin Only) -->
        <div class="tab-content admin-only" id="products">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>⚙️ จัดการสินค้า</h2>
                <button class="btn btn-primary" id="addProductBtn">+ เพิ่มสินค้าใหม่</button>
            </div>
            <div class="products-grid" id="productsManageGrid">
                <!-- Products management will be populated by JavaScript -->
            </div>
        </div>

        <!-- Reports Tab -->
        <div class="tab-content" id="reports">
            <h2>📊 รายงานยอดขาย</h2>
            <div class="reports-graph-section">
                <h3>ยอดขายสินค้าแต่ละตัว (Top 10) รายเดือน</h3>
                <select id="topProductMonth" style="margin-bottom:10px;"></select>
                <canvas id="topProductChart" height="120"></canvas>
                <h3 style="margin-top:32px;">ยอดขายรวมรายเดือน</h3>
                <select id="monthlySalesYear" style="margin-bottom:10px;"></select>
                <canvas id="monthlySalesChart" height="120"></canvas>
            </div>
            <div class="reports-grid" id="reportsGrid">
                <!-- Reports will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div class="modal" id="adminLoginModal">
        <div class="modal-content">
            <h2>🔐 เข้าสู่ระบบผู้ดูแล</h2>
            <div class="form-group">
                <label>รหัสผ่าน</label>
                <input type="password" id="adminPassword" placeholder="กรอกรหัสผ่าน">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" id="cancelLogin">ยกเลิก</button>
                <button class="btn btn-primary" id="confirmLogin">เข้าสู่ระบบ</button>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <h2 id="productModalTitle">เพิ่มสินค้าใหม่</h2>
            <div class="form-group">
                <label>ชื่อสินค้า</label>
                <input type="text" id="productName" placeholder="ชื่อสินค้า">
            </div>
            <div class="form-group">
                <label>ยี่ห้อ</label>
                <input type="text" id="productBrand" placeholder="ยี่ห้อ">
            </div>
            <div class="form-group">
                <label>ราคา (บาท)</label>
                <input type="number" id="productPrice" placeholder="0.00" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label>รูปภาพสินค้า</label>
                <input type="file" id="productImage" accept="image/*">
                <img id="imagePreview"
                    style="display: none; max-width: 200px; max-height: 200px; margin-top: 10px; border-radius: 10px;">
                <button type="button" id="removeImageBtn" onclick="removeImage()"
                    style="display: none; margin-top: 5px;" class="btn btn-secondary">ลบรูปภาพ</button>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" id="cancelProduct">ยกเลิก</button>
                <button class="btn btn-primary" id="saveProduct">บันทึก</button>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div class="modal" id="checkoutModal">
        <div class="modal-content">
            <h2>💳 ชำระเงิน</h2>
            <div class="form-group">
                <label>ยอดรวม</label>
                <input type="text" id="checkoutTotal" readonly>
            </div>
            <div class="form-group">
                <label>จำนวนเงินที่รับ</label>
                <input type="number" id="receivedAmount" placeholder="0.00" min="0" step="0.01">
            </div>
            <div class="form-group">
                <label>เงินทอน</label>
                <input type="text" id="changeAmount" readonly>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" id="cancelCheckout">ยกเลิก</button>
                <button class="btn btn-primary" id="confirmCheckout">ยืนยันการชำระเงิน</button>
            </div>
        </div>
    </div>

    <!-- Stock Modal -->
    <div class="modal" id="stockModal">
        <div class="modal-content">
            <h2 id="stockModalTitle">เพิ่ม Stock</h2>
            <div class="form-group">
                <label>สินค้า: <span id="stockProductName" style="font-weight: bold; color: #43a047;"></span></label>
            </div>
            <div class="form-group">
                <label>Stock ปัจจุบัน: <span id="stockCurrentAmount" style="font-weight: bold; color: #333;"></span> ถุง</label>
            </div>
            <div class="form-group">
                <label>จำนวนที่ต้องการ <span id="stockActionText">เพิ่ม</span></label>
                <input type="number" id="stockAmount" placeholder="0" min="1" step="1">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" id="cancelStock">ยกเลิก</button>
                <button class="btn btn-primary" id="confirmStock">ยืนยัน</button>
            </div>
        </div>
    </div>

    <!-- Notification History Modal -->
    <div class="modal" id="notificationHistoryModal">
        <div class="modal-content notification-history-content">
            <div class="notification-history-header">
                <h2>📋 ประวัติการแจ้งเตือน</h2>
                <button class="btn btn-danger" id="clearNotifications">🗑️ ล้างประวัติ</button>
            </div>
            <div class="notification-history-list" id="notificationHistoryList">
                <!-- Notification history will be populated here -->
            </div>
        </div>
    </div>

    <!-- Firebase & Firestore Integration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import {
            getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, onSnapshot
        } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB80Lw579vymHLg0-CfRYP989nSUdpIcA4",
            authDomain: "rice-pos.firebaseapp.com",
            projectId: "rice-pos",
            storageBucket: "rice-pos.firebasestorage.app",
            messagingSenderId: "932787497578",
            appId: "1:932787497578:web:8faa2b5094203113857813",
            measurementId: "G-1M294V875F"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global state
        let products = [];
        let cart = [];
        let currentMode = 'user';
        let currentEditingProduct = null;
        let salesHistory = [];
        let nextProductId = 1; // Not used, Firestore uses auto id
        let notificationHistory = [];
        let notificationCount = 0;

        // Real-time sync for products
        onSnapshot(collection(db, 'products'), (snapshot) => {
            products = [];
            snapshot.forEach(docSnap => {
                products.push({ id: docSnap.id, ...docSnap.data() });
            });
            renderProducts();
            renderStockManagement();
            renderProductsManagement();
            checkLowStock();
        });

        // Real-time sync for salesHistory
        onSnapshot(collection(db, 'salesHistory'), (snapshot) => {
            salesHistory = [];
            snapshot.forEach(docSnap => {
                salesHistory.push({ id: docSnap.id, ...docSnap.data() });
            });
            renderHistory();
            renderReports();
        });

        // Real-time sync for notificationHistory
        onSnapshot(collection(db, 'notificationHistory'), (snapshot) => {
            notificationHistory = [];
            snapshot.forEach(docSnap => {
                notificationHistory.push({ id: docSnap.id, ...docSnap.data() });
            });
            notificationCount = notificationHistory.filter(n => !n.read).length;
            updateNotificationBell();
        });

        // CRUD functions for Firestore
        async function addProductToFirestore(product) {
            await addDoc(collection(db, 'products'), product);
        }
        async function updateProductInFirestore(id, data) {
            await updateDoc(doc(db, 'products', id), data);
        }
        async function deleteProductFromFirestore(id) {
            await deleteDoc(doc(db, 'products', id));
        }
        async function addSaleToFirestore(sale) {
            await addDoc(collection(db, 'salesHistory'), sale);
        }
        async function addNotificationToFirestore(notification) {
            await addDoc(collection(db, 'notificationHistory'), notification);
        }
        async function clearNotificationHistoryFirestore() {
            // Delete all docs in notificationHistory
            const querySnapshot = await getDocs(collection(db, 'notificationHistory'));
            for (const docSnap of querySnapshot.docs) {
                await deleteDoc(doc(db, 'notificationHistory', docSnap.id));
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function () {
            initializePOSApp();
        });

        // เปลี่ยนชื่อฟังก์ชัน initializeApp เป็น initializePOSApp
        function initializePOSApp() {
            setupEventListeners();
            renderProducts();
            updateCart();
            updateModeVisibility();
            renderHistory();
            renderReports();
            updateNotificationBell(); // อัปเดตกระดิ่งแจ้งเตือน
            checkLowStock(); // ตรวจสอบ stock ต่ำ
        }

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    switchTab(this.dataset.tab);
                });
            });

            // Mode switching
            document.getElementById('userMode').addEventListener('click', () => switchMode('user'));
            document.getElementById('adminMode').addEventListener('click', () => switchMode('admin'));

            // Search and filters
            document.getElementById('searchProduct').addEventListener('input', renderProducts);
            document.getElementById('brandFilter').addEventListener('change', renderProducts);
            document.getElementById('minPrice').addEventListener('input', renderProducts);
            document.getElementById('maxPrice').addEventListener('input', renderProducts);

            // Modal handlers
            document.getElementById('cancelLogin').addEventListener('click', () => hideModal('adminLoginModal'));
            document.getElementById('confirmLogin').addEventListener('click', handleAdminLogin);
            document.getElementById('adminPassword').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    handleAdminLogin();
                }
            });
            document.getElementById('addProductBtn').addEventListener('click', () => showAddProductModal());
            document.getElementById('cancelProduct').addEventListener('click', () => hideModal('productModal'));
            document.getElementById('saveProduct').addEventListener('click', handleSaveProduct);

            // Product image upload
            document.getElementById('productImage').addEventListener('change', handleImageUpload);

            // Checkout
            document.getElementById('checkoutBtn').addEventListener('click', handleCheckout);
            document.getElementById('cancelCheckout').addEventListener('click', () => hideModal('checkoutModal'));
            document.getElementById('confirmCheckout').addEventListener('click', handleConfirmCheckout);
            document.getElementById('receivedAmount').addEventListener('input', calculateChange);
            document.getElementById('receivedAmount').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    handleConfirmCheckout();
                }
            });

            // Stock Modal
            document.getElementById('cancelStock').addEventListener('click', () => hideModal('stockModal'));
            document.getElementById('confirmStock').addEventListener('click', confirmStockUpdate);
            document.getElementById('stockAmount').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    confirmStockUpdate();
                }
            });

            // Notification Bell
            document.getElementById('notificationBell').addEventListener('click', showNotificationHistory);
            document.getElementById('clearNotifications').addEventListener('click', clearNotificationHistory);

            // Close modals when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        hideModal(this.id);
                    }
                });
            });

            // ในแท็บประวัติการขาย (history tab) ให้เพิ่ม input เลือกวันที่และปุ่ม Print PDF
            document.getElementById('historyStartDate').addEventListener('change', renderHistory);
            document.getElementById('historyEndDate').addEventListener('change', renderHistory);
            document.getElementById('printHistoryBtn').addEventListener('click', printHistoryPDF);

            const topProductMonth = document.getElementById('topProductMonth');
            const monthlySalesYear = document.getElementById('monthlySalesYear');
            if (topProductMonth) topProductMonth.addEventListener('change', renderReports);
            if (monthlySalesYear) monthlySalesYear.addEventListener('change', renderReports);
        }

        function switchTab(tabName) {
            // ตรวจสอบว่าเป็นแถบ admin-only หรือไม่
            if (tabName === 'products' && currentMode !== 'admin') {
                alert('คุณไม่มีสิทธิ์เข้าถึงหน้านี้');
                return;
            }

            // Hide all tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Show selected tab
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');

            // รีเฟรชเนื้อหาตามแถบ
            if (tabName === 'stock') {
                renderStockManagement();
            } else if (tabName === 'products') {
                renderProductsManagement();
            } else if (tabName === 'history') {
                renderHistory();
            } else if (tabName === 'reports') {
                renderReports();
            }
        }

        function switchMode(mode) {
            if (mode === 'admin') {
                showModal('adminLoginModal');
                // Focus ที่ input field อัตโนมัติ
                setTimeout(() => {
                    document.getElementById('adminPassword').focus();
                }, 100);
            } else {
                currentMode = 'user';
                document.getElementById('userMode').classList.add('active');
                document.getElementById('adminMode').classList.remove('active');
                document.getElementById('statusText').textContent = 'โหมดพนักงาน';
                updateModeVisibility();

                // ถ้าอยู่ในแถบ admin-only ให้กลับไปหน้าขาย
                const currentTab = document.querySelector('.tab.active');
                if (currentTab && currentTab.classList.contains('admin-only')) {
                    switchTab('sales');
                }
            }
        }

        function updateModeVisibility() {
            if (currentMode === 'admin') {
                document.body.classList.add('admin-mode');
            } else {
                document.body.classList.remove('admin-mode');

                // ถ้าไม่ใช่ admin และอยู่ในแถบ admin-only ให้กลับไปหน้าขาย
                const currentTab = document.querySelector('.tab.active');
                if (currentTab && currentTab.classList.contains('admin-only')) {
                    switchTab('sales');
                }
            }
        }
        function handleAdminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (password === 'admin123') {
                currentMode = 'admin';
                document.getElementById('adminMode').classList.add('active');
                document.getElementById('userMode').classList.remove('active');
                document.getElementById('statusText').textContent = 'โหมดผู้ดูแล';
                updateModeVisibility();
                hideModal('adminLoginModal');
                document.getElementById('adminPassword').value = '';

                // สลับไปหน้าจัดการสินค้าอัตโนมัติ
                switchTab('products');
            } else {
                alert('รหัสผ่านไม่ถูกต้อง');
                // Focus กลับที่ input field หลังจาก alert
                setTimeout(() => {
                    document.getElementById('adminPassword').focus();
                }, 100);
            }
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            const searchTerm = document.getElementById('searchProduct').value.toLowerCase();
            const brandFilter = document.getElementById('brandFilter').value;
            const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
            const maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;

            const filteredProducts = products.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) ||
                    product.brand.toLowerCase().includes(searchTerm);
                const matchesBrand = !brandFilter || product.brand === brandFilter;
                const matchesPrice = product.price >= minPrice && product.price <= maxPrice;
                return matchesSearch && matchesBrand && matchesPrice;
            });

            grid.innerHTML = filteredProducts.map(product => {
                let stockDisplay = '';
                if (typeof product.stock !== 'number' || isNaN(product.stock)) {
                    stockDisplay = '<span class="stock-badge" style="color: #f44336;">หมด</span>';
                } else if (product.stock === 0) {
                    stockDisplay = '<span class="stock-badge" style="color: #f44336;">หมด</span>';
                } else {
                    stockDisplay = `<span class="stock-badge">${product.stock} ถุง</span>`;
                }
                return `
                    <div class="product-card">
                        <div class="product-image ${product.image ? '' : 'placeholder'}">
                            ${product.image ? `<img src="${product.image}" alt="${product.name}">` : '🌾'}
                        </div>
                        <div class="product-info">
                            <h3>${product.name}</h3>
                            <div class="product-brand">${product.brand}</div>
                            <div class="product-price">${product.price.toFixed(2)} บาท</div>
                            <div class="product-stock">
                                คงเหลือ: ${stockDisplay}
                            </div>
                            <div class="product-actions">
                                <button class="btn btn-primary" onclick="addToCart('${product.id}')" 
                                        ${(product.stock === 0 || typeof product.stock !== 'number' || isNaN(product.stock)) ? 'disabled' : ''}>
                                    🛒 เพิ่มลงตะกร้า
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderStockManagement() {
            const grid = document.getElementById('stockGrid');
            grid.innerHTML = products.map(product => {
                let stockDisplay = '';
                if (typeof product.stock !== 'number' || isNaN(product.stock)) {
                    stockDisplay = '<span class="stock-badge" style="color: #f44336;">หมด</span>';
                } else if (product.stock === 0) {
                    stockDisplay = '<span class="stock-badge" style="color: #f44336;">หมด</span>';
                } else {
                    stockDisplay = `<span class="stock-badge">${product.stock} ถุง</span>`;
                }
                return `
                    <div class="product-card">
                        <div class="product-image ${product.image ? '' : 'placeholder'}">
                            ${product.image ? `<img src="${product.image}" alt="${product.name}">` : '🌾'}
                        </div>
                        <div class="product-info">
                            <h3>${product.name}</h3>
                            <div class="product-brand">${product.brand}</div>
                            <div class="product-price">${product.price.toFixed(2)} บาท</div>
                            <div class="product-stock">
                                คงเหลือ: ${stockDisplay}
                            </div>
                            <div class="stock-update">
                                <button class="btn btn-primary" onclick="showStockModal('${product.id}', 'add')">เพิ่ม</button>
                                <button class="btn btn-warning" onclick="showStockModal('${product.id}', 'reduce')">ลด</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderProductsManagement() {
            const grid = document.getElementById('productsManageGrid');
            grid.innerHTML = products.map(product => {
                let stockDisplay = '';
                if (typeof product.stock !== 'number' || isNaN(product.stock)) {
                    stockDisplay = '<span class="stock-badge" style="color: #f44336;">หมด</span>';
                } else if (product.stock === 0) {
                    stockDisplay = '<span class="stock-badge" style="color: #f44336;">หมด</span>';
                } else {
                    stockDisplay = `<span class="stock-badge">${product.stock} ถุง</span>`;
                }
                return `
                    <div class="product-card">
                        <div class="product-image ${product.image ? '' : 'placeholder'}">
                            ${product.image ? `<img src="${product.image}" alt="${product.name}">` : '🌾'}
                        </div>
                        <div class="product-info">
                            <h3>${product.name}</h3>
                            <div class="product-brand">${product.brand}</div>
                            <div class="product-price">${product.price.toFixed(2)} บาท</div>
                            <div class="product-stock">
                                คงเหลือ: ${stockDisplay}
                            </div>
                            <div class="product-actions">
                                <button class="btn btn-warning" onclick="editProduct('${product.id}')">
                                    ✏️ แก้ไข
                                </button>
                                <button class="btn btn-danger" onclick="deleteProduct('${product.id}')">
                                    🗑️ ลบ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || product.stock === 0) return;

            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity++;
                } else {
                    alert('สินค้าไม่เพียงพอ');
                    return;
                }
            } else {
                cart.push({
                    id: productId,
                    name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }

            updateCart();
            renderProducts();
        }
        window.addToCart = addToCart;

        function removeFromCart(productId) {
            const index = cart.findIndex(item => item.id === productId);
            if (index !== -1) {
                cart.splice(index, 1);
                updateCart();
                renderProducts();
            }
        }
        window.removeFromCart = removeFromCart;

        function updateQuantity(productId, change) {
            const item = cart.find(item => item.id === productId);
            const product = products.find(p => p.id === productId);

            if (item && product) {
                const newQuantity = item.quantity + change;
                if (newQuantity > 0 && newQuantity <= product.stock) {
                    item.quantity = newQuantity;
                } else if (newQuantity <= 0) {
                    removeFromCart(productId);
                    return;
                } else {
                    alert('สินค้าไม่เพียงพอ');
                    return;
                }
                updateCart();
            }
        }
        window.updateQuantity = updateQuantity;

        function updateCart() {
            const cartItems = document.getElementById('cartItems');
            const cartCount = document.getElementById('cartCount');
            const totalAmount = document.getElementById('totalAmount');
            const checkoutBtn = document.getElementById('checkoutBtn');

            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div class="empty-state">
                        <h3>ตะกร้าสินค้าว่างเปล่า</h3>
                        <p>เพิ่มสินค้าลงในตะกร้าเพื่อเริ่มการขาย</p>
                    </div>
                `;
                checkoutBtn.disabled = true;
            } else {
                cartItems.innerHTML = cart.map(item => `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-price">${item.price.toFixed(2)} บาท</div>
                        </div>
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="updateQuantity('${item.id}', -1)">-</button>
                            <input type="number" class="quantity" min="1" max="${(products.find(p=>p.id===item.id)?.stock) ?? 1}" value="${item.quantity}" style="width:50px;text-align:center;" 
                                onchange="setCartQuantity('${item.id}', this.value)" 
                                onblur="setCartQuantity('${item.id}', this.value)"
                                onkeydown="if(event.key==='Enter'){setCartQuantity('${item.id}', this.value)}">
                            <button class="quantity-btn" onclick="updateQuantity('${item.id}', 1)">+</button>
                        </div>
                        <button class="btn btn-danger" onclick="removeFromCart('${item.id}')">
                            🗑️
                        </button>
                    </div>
                `).join('');
                checkoutBtn.disabled = false;
            }

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            cartCount.textContent = `${cart.length} รายการ`;
            totalAmount.textContent = `${total.toFixed(2)} บาท`;
        }

        let currentStockProductId = null;
        let currentStockAction = null;

        function showStockModal(productId, action) {
            currentStockProductId = productId;
            currentStockAction = action;
            
            const product = products.find(p => p.id === productId);
            const modalTitle = document.getElementById('stockModalTitle');
            const actionText = document.getElementById('stockActionText');
            const productName = document.getElementById('stockProductName');
            const currentAmount = document.getElementById('stockCurrentAmount');
            const amountInput = document.getElementById('stockAmount');
            
            if (action === 'add') {
                modalTitle.textContent = 'เพิ่ม Stock';
                actionText.textContent = 'เพิ่ม';
            } else {
                modalTitle.textContent = 'ลด Stock';
                actionText.textContent = 'ลด';
            }
            
            // แสดงข้อมูลสินค้าและ Stock ปัจจุบัน
            productName.textContent = product.name;
            currentAmount.textContent = product.stock;
            
            amountInput.value = '';
            showModal('stockModal');
            
            // Focus ที่ input field อัตโนมัติ
            setTimeout(() => {
                amountInput.focus();
            }, 100);
        }
        window.showStockModal = showStockModal;

        function confirmStockUpdate() {
            const amount = parseInt(document.getElementById('stockAmount').value) || 0;
            const product = products.find(p => p.id === currentStockProductId);

            if (!product || amount <= 0) {
                alert('กรุณาใส่จำนวนที่ถูกต้อง');
                return;
            }

            let newStock;
            if (currentStockAction === 'add') {
                newStock = (typeof product.stock === 'number' && !isNaN(product.stock) ? product.stock : 0) + amount;
            } else {
                newStock = (typeof product.stock === 'number' && !isNaN(product.stock) ? product.stock : 0) - amount;
                if (newStock < 0) {
                    alert('ไม่สามารถลด Stock ต่ำกว่า 0 ได้');
                    return;
                }
            }

            // อัปเดต stock ใน Firestore เท่านั้น
            updateProductInFirestore(product.id, { stock: newStock });

            hideModal('stockModal');
            renderStockManagement();
            renderProducts();

            const action = currentStockAction === 'add' ? 'เพิ่ม' : 'ลด';
            alert(`${action} Stock สำเร็จ! ${amount} ถุง`);

            // ตรวจสอบ stock ต่ำหลังจากอัปเดต
            checkLowStock();
        }

        function showAddProductModal() {
            currentEditingProduct = null;
            document.getElementById('productModalTitle').textContent = 'เพิ่มสินค้าใหม่';
            document.getElementById('productName').value = '';
            document.getElementById('productBrand').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('imagePreview').src = '';
            document.getElementById('removeImageBtn').style.display = 'none';
            showModal('productModal');
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                currentEditingProduct = product;
                document.getElementById('productModalTitle').textContent = 'แก้ไขสินค้า';
                document.getElementById('productName').value = product.name;
                document.getElementById('productBrand').value = product.brand;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productImage').value = '';

                if (product.image) {
                    document.getElementById('imagePreview').src = product.image;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('removeImageBtn').style.display = 'block';
                } else {
                    document.getElementById('imagePreview').style.display = 'none';
                    document.getElementById('removeImageBtn').style.display = 'none';
                }

                showModal('productModal');
            }
        }
        window.editProduct = editProduct;

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('ขนาดไฟล์ต้องไม่เกิน 5MB');
                    event.target.value = '';
                    return;
                }

                // Check file type
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                if (!allowedTypes.includes(file.type)) {
                    alert('รองรับเฉพาะไฟล์ JPG, PNG, GIF, WebP เท่านั้น');
                    event.target.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function removeImage() {
            document.getElementById('productImage').value = '';
            document.getElementById('imagePreview').src = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('removeImageBtn').style.display = 'none';

            // If editing existing product, remove image from product
            if (currentEditingProduct) {
                currentEditingProduct.image = null;
            }
        }
        window.removeImage = removeImage;

        function handleSaveProduct() {
            const name = document.getElementById('productName').value.trim();
            const brand = document.getElementById('productBrand').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const imageFile = document.getElementById('productImage').files[0];

            if (!name || !brand || isNaN(price)) {
                alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            // Handle image
            let imageData = null;
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    imageData = e.target.result;
                    saveProductData(name, brand, price, imageData);
                };
                reader.readAsDataURL(imageFile);
            } else {
                // Use existing image if editing
                imageData = currentEditingProduct ? currentEditingProduct.image : null;
                saveProductData(name, brand, price, imageData);
            }
        }

        function saveProductData(name, brand, price, imageData) {
            if (currentEditingProduct) {
                // Edit existing product
                currentEditingProduct.name = name;
                currentEditingProduct.brand = brand;
                currentEditingProduct.price = price;
                if (imageData !== undefined) {
                    currentEditingProduct.image = imageData;
                }
                updateProductInFirestore(currentEditingProduct.id, {
                    name: name,
                    brand: brand,
                    price: price,
                    image: imageData
                });
            } else {
                // Add new product
                const newProduct = {
                    name: name,
                    brand: brand,
                    price: price,
                    image: imageData
                };
                addProductToFirestore(newProduct);
            }

            hideModal('productModal');
            renderProducts();
            renderStockManagement();
            renderProductsManagement();

        }

        function deleteProduct(productId) {
            if (confirm('คุณแน่ใจหรือไม่ที่จะลบสินค้านี้?')) {
                deleteProductFromFirestore(productId);
                removeFromCart(productId); // Also remove from cart if it exists
                renderProducts();
                renderProductsManagement();
                renderStockManagement();
            }
        }
        window.deleteProduct = deleteProduct;

        function handleCheckout() {
            if (cart.length === 0) return;

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('checkoutTotal').value = `${total.toFixed(2)} บาท`;
            document.getElementById('receivedAmount').value = '';
            document.getElementById('changeAmount').value = '';
            showModal('checkoutModal');
            
            // Focus ที่ input field อัตโนมัติ
            setTimeout(() => {
                document.getElementById('receivedAmount').focus();
            }, 100);
        }

        function calculateChange() {
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const received = parseFloat(document.getElementById('receivedAmount').value) || 0;
            const change = received - total;
            document.getElementById('changeAmount').value = change >= 0 ? `${change.toFixed(2)} บาท` : '0.00 บาท';
        }

        function handleConfirmCheckout() {
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const received = parseFloat(document.getElementById('receivedAmount').value) || 0;

            if (received < total) {
                alert('จำนวนเงินที่รับไม่เพียงพอ');
                return;
            }

            // Update stock
            cart.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (product) {
                    product.stock -= item.quantity;
                    updateProductInFirestore(product.id, { stock: product.stock });
                }
            });

            // Add to sales history
            const newSale = {
                date: new Date().toLocaleString('th-TH'),
                items: [...cart],
                total: total,
                received: received,
                change: received - total
            };
            addSaleToFirestore(newSale);

            // Clear cart
            cart = [];
            updateCart();
            renderProducts();
            hideModal('checkoutModal');

            alert(`ขายสำเร็จ!\nยอดรวม: ${total.toFixed(2)} บาท\nเงินทอน: ${(received - total).toFixed(2)} บาท`);
            
            // ตรวจสอบ stock ต่ำหลังจากขาย
            checkLowStock();
        }

        function renderHistory() {
            const historyList = document.getElementById('historyList');
            const startDateInput = document.getElementById('historyStartDate');
            const endDateInput = document.getElementById('historyEndDate');
            let filtered = salesHistory.slice();
            // filter ตามวันที่
            if (startDateInput && startDateInput.value) {
                const start = new Date(startDateInput.value + 'T00:00:00');
                filtered = filtered.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= start;
                });
            }
            if (endDateInput && endDateInput.value) {
                const end = new Date(endDateInput.value + 'T23:59:59');
                filtered = filtered.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate <= end;
                });
            }
            if (filtered.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <h3>ยังไม่มีประวัติการขาย</h3>
                        <p>เมื่อมีการขายสินค้าแล้ว ประวัติจะแสดงที่นี่</p>
                    </div>
                `;
                return;
            }
            // ใช้ slice().reverse() เพื่อไม่กระทบต้นฉบับ
            historyList.innerHTML = filtered.slice().reverse().map(sale => `
                <div class="history-item">
                    <div class="history-header">
                        <span class="history-date">${sale.date}</span>
                        <span class="history-total">${sale.total.toFixed(2)} บาท</span>
                    </div>
                    <div class="history-items">
                        ${sale.items.map(item => `${item.name} x${item.quantity}`).join(', ')}
                    </div>
                </div>
            `).join('');
        }

        function checkLowStock() {
            const lowStockThreshold = 10; // เกณฑ์ stock ต่ำ (น้อยกว่า 10 ถุง)
            const lowStockProducts = products.filter(p => p.stock < lowStockThreshold);
            
            if (lowStockProducts.length > 0) {
                showLowStockNotification(lowStockProducts);
            }
        }

        function showLowStockNotification(lowStockProducts) {
            // บันทึกประวัติการแจ้งเตือน
            const notificationRecord = {
                type: 'low_stock',
                title: 'สินค้าใกล้หมด',
                message: `มีสินค้า ${lowStockProducts.length} รายการที่มี stock ต่ำกว่า 10 ถุง`,
                products: lowStockProducts.map(p => `${p.name} - เหลือ ${p.stock} ถุง`),
                timestamp: new Date().toLocaleString('th-TH'),
                read: false
            };
            addNotificationToFirestore(notificationRecord);
            
            const notification = document.createElement('div');
            notification.className = 'low-stock-notification';
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-header">
                        <span class="notification-icon">⚠️</span>
                        <span class="notification-title">สินค้าใกล้หมด</span>
                        <button class="notification-close" onclick="this.parentElement.parentElement.remove()">×</button>
                    </div>
                    <div class="notification-body">
                        <p>มีสินค้า ${lowStockProducts.length} รายการที่มี stock ต่ำกว่า 10 ถุง:</p>
                        <ul>
                            ${lowStockProducts.map(product => `
                                <li>${product.name} - เหลือ ${product.stock} ถุง</li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // ลบการแจ้งเตือนอัตโนมัติหลัง 10 วินาที
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }

        function updateNotificationBell() {
            const countElement = document.getElementById('notificationCount');
            if (notificationCount > 0) {
                countElement.textContent = notificationCount;
                countElement.classList.remove('hidden');
            } else {
                countElement.classList.add('hidden');
            }
        }

        function showNotificationHistory() {
            const historyList = document.getElementById('notificationHistoryList');
            
            if (notificationHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-state">
                        <h3>ไม่มีประวัติการแจ้งเตือน</h3>
                        <p>เมื่อมีการแจ้งเตือนใหม่ ประวัติจะแสดงที่นี่</p>
                    </div>
                `;
            } else {
                historyList.innerHTML = notificationHistory.map(notification => `
                    <div class="notification-item">
                        <div class="notification-item-header">
                            <div class="notification-item-title">
                                <span>⚠️</span>
                                ${notification.title}
                            </div>
                            <div class="notification-item-time">${notification.timestamp}</div>
                        </div>
                        <div class="notification-item-content">
                            <p>${notification.message}</p>
                            <ul>
                                ${notification.products.map(product => `<li>${product}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `).join('');
            }
            
            showModal('notificationHistoryModal');
        }

        function clearNotificationHistory() {
            if (confirm('คุณแน่ใจหรือไม่ที่จะล้างประวัติการแจ้งเตือนทั้งหมด?')) {
                clearNotificationHistoryFirestore();
                notificationHistory = [];
                notificationCount = 0;
                updateNotificationBell();
                hideModal('notificationHistoryModal');
                alert('ล้างประวัติการแจ้งเตือนเรียบร้อยแล้ว');
            }
        }

        // เพิ่มฟังก์ชัน printHistoryPDF สำหรับพิมพ์/ดาวน์โหลด PDF
        function printHistoryPDF() {
            // print เฉพาะส่วนประวัติการขาย
            const printContents = document.getElementById('historyListPrintArea').innerHTML;
            const originalContents = document.body.innerHTML;
            document.body.innerHTML = `<h2 style='text-align:center;'>ประวัติการขาย</h2>` + printContents;
            window.print();
            document.body.innerHTML = originalContents;
            location.reload(); // reload เพื่อให้ event กลับมา
        }

        let topProductChartInstance = null;
        let monthlySalesChartInstance = null;
        // ฟังก์ชันแปลงวันที่ไทย/พ.ศ. เป็น Date
        function parseDateThai(str) {
            // รองรับ "1/7/2567, 13:00:00" หรือ "1/7/2024, 13:00:00"
            if (!str) return new Date(NaN);
            let [datePart, timePart] = str.split(',');
            if (!datePart) return new Date(NaN);
            let [d, m, y] = datePart.trim().split('/');
            if (!d || !m || !y) return new Date(NaN);
            // ถ้าเป็นปี พ.ศ. ให้ลบ 543
            if (y.length === 4 && +y > 2400) y = (+y - 543).toString();
            let iso = `${y.padStart(4, '0')}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
            if (timePart) iso += 'T' + timePart.trim();
            return new Date(iso);
        }
        function renderReports() {
            const reportsGrid = document.getElementById('reportsGrid');
            const topProductMonth = document.getElementById('topProductMonth');
            const monthlySalesYear = document.getElementById('monthlySalesYear');

            // ====== เตรียมข้อมูลเดือน/ปีที่มีใน salesHistory ======
            const monthSet = new Set();
            const yearSet = new Set();
            salesHistory.forEach(sale => {
                const date = parseDateThai(sale.date);
                if (isNaN(date.getTime())) return;
                const month = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}`;
                const year = date.getFullYear();
                monthSet.add(month);
                yearSet.add(year);
            });
            const months = Array.from(monthSet).sort();
            const years = Array.from(yearSet).sort();

            // ====== สร้าง options ให้ select ======
            if (topProductMonth) {
                topProductMonth.innerHTML = months.map(m => {
                    const [y, mo] = m.split('-');
                    return `<option value="${m}">${mo}/${y}</option>`;
                }).join('');
                // เลือกเดือนล่าสุดถ้ายังไม่ได้เลือก
                if (!topProductMonth.value && months.length > 0) topProductMonth.value = months[months.length-1];
            }
            if (monthlySalesYear) {
                monthlySalesYear.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
                // เลือกปีล่าสุดถ้ายังไม่ได้เลือก
                if (!monthlySalesYear.value && years.length > 0) monthlySalesYear.value = years[years.length-1];
            }

            // ====== กราฟ Top Product รายเดือน (Top 10) ======
            let selectedMonth = topProductMonth && topProductMonth.value ? topProductMonth.value : null;
            const productMap = {};
            salesHistory.forEach(sale => {
                const date = parseDateThai(sale.date);
                if (isNaN(date.getTime())) return;
                const month = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}`;
                if (selectedMonth && month !== selectedMonth) return;
                sale.items.forEach(item => {
                    if (!productMap[item.name]) productMap[item.name] = 0;
                    productMap[item.name] += item.quantity;
                });
            });
            // Top 10
            const topProductsArr = Object.entries(productMap)
                .map(([name, qty]) => ({name, qty}))
                .sort((a,b)=>b.qty-a.qty)
                .slice(0,10);
            const topProductLabels = topProductsArr.map(p=>p.name);
            const topProductData = topProductsArr.map(p=>p.qty);
            if (topProductChartInstance) topProductChartInstance.destroy();
            const ctx1 = document.getElementById('topProductChart').getContext('2d');
            topProductChartInstance = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: topProductLabels,
                    datasets: [{
                        label: 'จำนวนที่ขาย (ถุง)',
                        data: topProductData,
                        backgroundColor: topProductLabels.map((_,i)=>`hsl(${i*36},70%,60%)`),
                        borderColor: topProductLabels.map((_,i)=>`hsl(${i*36},70%,40%)`),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'จำนวนที่ขาย (ถุง)' } }
                    }
                }
            });

            // ====== กราฟยอดขายรวมรายเดือน (เลือกปี) ======
            let selectedYear = monthlySalesYear && monthlySalesYear.value ? parseInt(monthlySalesYear.value) : null;
            const monthlySalesMap = {};
            salesHistory.forEach(sale => {
                const date = parseDateThai(sale.date);
                if (isNaN(date.getTime())) return;
                const year = date.getFullYear();
                const month = date.getMonth()+1;
                if (selectedYear && year !== selectedYear) return;
                const monthLabel = `${year}-${month.toString().padStart(2,'0')}`;
                if (!monthlySalesMap[monthLabel]) monthlySalesMap[monthLabel] = 0;
                monthlySalesMap[monthLabel] += sale.total;
            });
            // สร้าง labels 12 เดือนของปีที่เลือก
            const monthlyLabels = Array.from({length:12},(_,i)=>`${selectedYear}-${(i+1).toString().padStart(2,'0')}`);
            const monthlyData = monthlyLabels.map(m => monthlySalesMap[m] || 0);
            if (monthlySalesChartInstance) monthlySalesChartInstance.destroy();
            const ctx2 = document.getElementById('monthlySalesChart').getContext('2d');
            monthlySalesChartInstance = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: monthlyLabels.map(m=>{
                        const [y,mo]=m.split('-');
                        return `${mo}/${y}`;
                    }),
                    datasets: [{
                        label: 'ยอดขายรวม (บาท)',
                        data: monthlyData,
                        fill: true,
                        backgroundColor: 'rgba(67,160,71,0.15)',
                        borderColor: '#43a047',
                        tension: 0.2,
                        pointRadius: 4,
                        pointBackgroundColor: '#43a047',
                        pointBorderColor: '#fff',
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'บาท' } }
                    }
                }
            });

            // ... สรุปตัวเลขเดิม ...
            const totalSales = salesHistory.reduce((sum, sale) => sum + sale.total, 0);
            const totalTransactions = salesHistory.length;
            const totalProducts = products.length;
            const lowStockProducts = products.filter(p => p.stock < 10).length;
            const avgSale = totalTransactions > 0 ? totalSales / totalTransactions : 0;

            reportsGrid.innerHTML = `
                <div class="report-card">
                    <h3>ยอดขายรวม</h3>
                    <div class="report-value">${totalSales.toFixed(2)}</div>
                    <div class="report-label">บาท</div>
                </div>
                <div class="report-card">
                    <h3>จำนวนการขาย</h3>
                    <div class="report-value">${totalTransactions}</div>
                    <div class="report-label">ครั้ง</div>
                </div>
                <div class="report-card">
                    <h3>จำนวนสินค้า</h3>
                    <div class="report-value">${totalProducts}</div>
                    <div class="report-label">รายการ</div>
                </div>
                <div class="report-card">
                    <h3>สินค้าใกล้หมด</h3>
                    <div class="report-value">${lowStockProducts}</div>
                    <div class="report-label">รายการ</div>
                </div>
                <div class="report-card">
                    <h3>ยอดขายเฉลี่ย</h3>
                    <div class="report-value">${avgSale.toFixed(2)}</div>
                    <div class="report-label">บาท/ครั้ง</div>
                </div>
                <div class="report-card">
                    <h3>Stock รวม</h3>
                    <div class="report-value">${products.reduce((sum, p) => sum + p.stock, 0)}</div>
                    <div class="report-label">ถุง</div>
                </div>
            `;
        }

        // เพิ่มฟังก์ชัน setCartQuantity
        function setCartQuantity(productId, value) {
            const item = cart.find(item => item.id === productId);
            const product = products.find(p => p.id === productId);
            let qty = parseInt(value);
            if (!item || !product || isNaN(qty)) return;
            if (qty < 1) qty = 1;
            if (qty > product.stock) qty = product.stock;
            item.quantity = qty;
            updateCart();
        }
        window.setCartQuantity = setCartQuantity;
    </script>
</body>

</html>